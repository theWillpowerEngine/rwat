<!DOCTYPE html>
<html>
  <head>
    <title>Riven World:  Airship Trader</title>
    <script>window.$ = window.jQuery = require('./stuff/libs/jquery.js');</script>
    <script src="./stuff/libs/rot.js"></script>
    <script src="./stuff/libs/keys.js"></script>

    <link rel="stylesheet" href="./stuff/css/site.css">
  </head>
  <body>
    <div id="container">
      <div id="header"> </div>
      <div id="game"> </div>
      <div id="sidetop"> </div>
      <div id="sidebottom">
        <div id="log" style="overflow-y: scroll; width: 100%; height: 100%; border: 0; padding: 0; margin: 0;"> 
        
        </div>  
      </div>
      <div id="footer"> </div>
    </div>


    <script>
      const { ipcRenderer } = require("electron")
      const makeEngine = require("./src/engine.js")
      const getCursorPosition = (canvas, event) => {
        const rect = canvas.getBoundingClientRect()
        const x = event.clientX - rect.left
        const y = event.clientY - rect.top
        return {x, y}
      }

      window.onerror = function(msg, url, line, col, error) {
        var extra = !col ? '' : '\ncolumn: ' + col;
        extra += !error ? '' : '\nerror: ' + error;

        var suppressErrorAlert = false;
        ipcRenderer.invoke("showDev")
        return suppressErrorAlert;
      };

      const engine = makeEngine(msg => {
        var $log = $("#log")
        $log.append(msg)
        $log[0].scrollTop = $log[0].scrollHeight;
      })

      $(() => {
        engine.init((step, msg) => {
          $("#log").append(`Step ${step} done: ${msg}.<br />`)
        })
        engine.render()

        $("canvas").on('mousedown', e => {
          var coords = getCursorPosition(e.target, e)
          coords.x = Math.trunc(coords.x /= 20)
          coords.y = Math.trunc(coords.y /= 20)
          console.log(engine.renderer.getTileAt(coords.x, coords.y).desc)
        })
      })
    </script>
  </body>
</html>